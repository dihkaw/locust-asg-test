name: Website Load Test with CSV Metrics

on:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ secrets.TARGET_URL }} 
      TEST_USERS: 5000  
      TEST_SPAWN_RATE: 50 
      TEST_RUN_TIME: "3m" 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust
        run: pip install locust 

      - name: Create Locustfile
        run: |
          cat <<EOF > locustfile.py
          from locust import HttpUser, task, between
          import logging

          class WebsiteUser(HttpUser):
              wait_time = between(0.5, 2.0) 
              
              @task
              def access_homepage(self):
                  self.client.get("/")
          EOF

      - name: Run Load Test
        run: |
          echo ">>> Memulai Pengujian pada $TARGET_URL"
          
          # Menambahkan parameter --csv untuk mencatat histori setiap detik
          locust -f locustfile.py \
            --host "$TARGET_URL" \
            --headless \
            -u $TEST_USERS \
            -r $TEST_SPAWN_RATE \
            --run-time $TEST_RUN_TIME \
            --csv "load_test_results" \
            --html "load_test_report.html" \
            --only-summary

      - name: Upload Test Report & CSV Metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: website-load-test-results
          path: |
            load_test_report.html
            load_test_results_stats_history.csv
            load_test_results_stats.csv
            load_test_results_failures.csv
