name: ASG Replication Load Test - Dynamic

on:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    # Definisikan variabel kustom di sini agar mudah diubah
    env:
      TEST_USERS: 3000 # Jumlah total user
      TEST_SPAWN_RATE: 50 # Penambahan user tiap detik
      TEST_RUN_TIME: "10m" # Format Locust (misal: 10m, 1h)


    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust
        run: pip install locust 

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create Locustfile
        run: |
          cat <<EOF > locustfile.py
          from locust import HttpUser, task, between
          class ASGLoadTest(HttpUser):
              wait_time = between(0.1, 0.5) 
              @task
              def access_homepage(self):
                  self.client.get("/")
          EOF

      - name: Initialize CSV File
        run: echo "Timestamp,RunningInstances" > instance_metrics.csv

      - name: Run Load Test & Monitor Instances
        env:
          ALB_URL: ${{ secrets.ALB_URL }}
        run: |
          echo ">>> Memulai Pengujian dengan $TEST_USERS User..."
          
          # Jalankan pemantauan instance di background (setiap 60 detik)
          (
            # Loop selama durasi pengujian (konversi 10m ke detik jika perlu, atau pakai loop manual)
            while true; do
              TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              COUNT=$(aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query "length(Reservations[*].Instances[])" --output text)
              echo "$TIMESTAMP,$COUNT" >> instance_metrics.csv
              sleep 60
            done
          ) &
          MONITOR_PID=$! # Simpan ID proses pemantauan
          
          # Jalankan Locust
          locust -f locustfile.py --host "$ALB_URL" --headless \
            -u $TEST_USERS \
            -r $TEST_SPAWN_RATE \
            --run-time $TEST_RUN_TIME \
            --html "stress_test_report.html" --only-summary || true
          
          # Matikan pemantauan background setelah test selesai
          kill $MONITOR_PID
          echo ">>> Pengujian Selesai. Data instance dicatat ke CSV."

      - name: Final Provisioning Check
        if: always()
        run: |
          echo "Menunggu 60 detik untuk pengecekan terakhir..."
          sleep 60
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COUNT=$(aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query "length(Reservations[*].Instances[])" --output text)
          echo "$TIMESTAMP,$COUNT" >> instance_metrics.csv

      - name: Upload Test Artifacts (HTML & CSV)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            stress_test_report.html
            instance_metrics.csv
