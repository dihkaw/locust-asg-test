name: ASG Replication Load Test

on:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust
        run: pip install locust

      - name: Create Locustfile
        run: |
          cat <<EOF > locustfile.py
          import logging
          from locust import HttpUser, task, between, events

          logging.basicConfig(level=logging.INFO)

          class ASGLoadTest(HttpUser):
              wait_time = between(1, 5)

              @task(3)
              def access_homepage(self):
                  with self.client.get("/", catch_response=True) as response:
                      if response.status_code == 200:
                          response.success()
                      elif response.status_code in [502, 503, 504]:
                          response.failure(f"ALB Error: {response.status_code}")
                      else:
                          response.failure(f"Error: {response.status_code}")

              @task(1)
              def cpu_intensive_task(self):
                  self.client.get("/heavy-compute")
          EOF

      - name: Run Load Test Scenarios
        env:
          ALB_URL: ${{ secrets.ALB_URL }}
        run: |
          # Gunakan satu perintah locust per tahap agar log lebih jelas
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          echo "Starting Baseline..."
          locust -f locustfile.py --host "$ALB_URL" --headless -u 200 -r 5 --run-time 1m --html "baseline.html" --only-summary || true
          
          echo "Cooldown 30s..."
          sleep 30

          echo "Starting Stress Test (Trigger ASG)..."
          locust -f locustfile.py --host "$ALB_URL" --headless -u 500 -r 10 --run-time 1m --html "stress.html" --only-summary || true

      - name: Upload Test Reports
        if: always() # Pastikan laporan tetap diupload meskipun tes sebelumnya error
        uses: actions/upload-artifact@v4
        with:
          name: locust-reports
          path: "*.html"
