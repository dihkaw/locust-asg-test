name: ASG Replication Load Test

on:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust
        run: pip install locust 

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create Locustfile
        run: |
          cat <<EOF > locustfile.py
          import logging
          from locust import HttpUser, task, between, events

          logging.basicConfig(level=logging.INFO)

          class ASGLoadTest(HttpUser):
              # Wait time diperkecil agar request lebih agresif
              wait_time = between(0.1, 0.5) 

              @task(10)
              def access_homepage(self):
                  # Menyerang root dengan load besar untuk memicu CPU overhead
                  self.client.get("/")

          @events.test_stop.add_listener
          def on_test_stop(environment, **kwargs):
              print("\nSCENARIO FINISHED\n")
          EOF

      - name: Stress Test & Scaling Trigger (Aggressive)
        env:
          ALB_URL: ${{ secrets.ALB_URL }}
        run: |
          echo ">>> Memulai Stress Test durasi panjang (10 Menit)..."
          echo ">>> Target: Memicu CloudWatch Alarm"
          
          # Menjalankan 1500 users selama 10 menit tanpa putus
          locust -f locustfile.py --host "$ALB_URL" --headless \
            -u 1500 \
            -r 50 \
            --run-time 10m \
            --html "stress_test_report.html" --only-summary || true

      - name: Wait for ASG Provisioning
        if: always()
        run: |
          echo "Menunggu 3 menit tambahan untuk sinkronisasi EC2 ke ALB..."
          sleep 180
          
      - name: Final Instance Check
        if: always()
        run: |
          echo ">>> Jumlah Instance Akhir:"
          aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" \
            --query "length(Reservations[*].Instances[])" \
            --output text
          
          echo ">>> Detail Instance ID dan Tipe:"
          aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].[InstanceId,InstanceType,LaunchTime]" \
            --output table

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: locust-asg-reports-revised
          path: "*.html"
